name: Desplegar Backend a Kubernetes

on:
  workflow_dispatch: 
jobs:
  deploy:
    runs-on: self-hosted  # Usa el runner local

    steps:
    - name: Checkout del código
      uses: actions/checkout@v3

    - name: Extraer la versión del release
      id: version
      run: |
        echo "RELEASE_VERSION=${{ github.event.release.tag_name }}" >> $GITHUB_ENV

    - name: Inyectar el nombre de la imagen Docker
      env:
        DOCKER_IMAGE_NAME: ${{ secrets.DOCKER_IMAGE_NAME }}
      run: |
        echo "IMAGE_NAME=${{ env.DOCKER_IMAGE_NAME }}:latest" >> $GITHUB_ENV
        echo "Imagen Docker: ${{ env.IMAGE_NAME }}"

    - name: Crear o actualizar Deployment en Kubernetes
      env:
        IMAGE_NAME: ${{ env.IMAGE_NAME }}
      run: |
        if kubectl get deployment serviduino-backend -n serviduino > /dev/null 2>&1; then
          echo "El Deployment ya existe. Actualizando la imagen..."
          kubectl set image deployment/serviduino-backend serviduino-backend=${IMAGE_NAME} -n serviduino
        else
          echo "El Deployment no existe. Creándolo..." 
          sed -i "s|IMAGE_NAME_PLACEHOLDER|${IMAGE_NAME}|g" backend/k8s/deployment.yaml
          kubectl apply -f backend/k8s/deployment.yaml
        fi
